<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<title>Painel de Cadastro - PESADAS</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#0e1720;color:#fff;padding:20px;}
  .card{background:#fff;color:#111;border-radius:12px;padding:18px;max-width:900px;margin:8px auto;}
  h1{margin-top:0}
  input, button, select, textarea{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc;box-sizing:border-box}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .thumb{width:140px;height:90px;object-fit:cover;border-radius:6px;border:1px solid #ddd}
  .items{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px}
  .item{background:#f6f6f6;padding:8px;border-radius:8px;color:#000;width:200px}
  button.primary{background:#2d8a4f;color:#fff;border:none;cursor:pointer}
  button.warn{background:#c0392b;color:#fff;border:none;cursor:pointer}
  .small{font-size:13px;padding:8px}
  .inline{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>

<div class="card">
  <h1>PAINEL DE EXIBIÇÃO TV</h1>

  <label><b>Tempo de exibição (ms)</b></label>
  <input id="tempo" type="number" placeholder="Ex: 5000" />

  <div class="inline">
    <button class="primary small" id="salvarTempoBtn">Salvar Tempo</button>
    <button id="recarregarLista" class="small">Recarregar Lista</button>
  </div>

  <hr>

  <label><b>Selecionar imagens (pode selecionar várias)</b></label>
  <input id="files" type="file" accept="image/*" multiple />
  <div class="inline">
    <button id="enviarBtn" class="primary">Enviar Imagens</button>
    <div id="progress" style="margin-left:12px"></div>
  </div>

  <h3>Imagens cadastradas</h3>
  <div id="lista" class="items"></div>
</div>

<script type="module">
/*
  Cadastro atualizado:
  - Upload em lote (múltiplos arquivos) para ImgBB (envia base64)
  - Grava cada imagem com push() em RELATORIOS-PESADAS-PRTNRV/imagens
  - Permite excluir (botão) com confirmação
  - Salvar tempo em RELATORIOS-PESADAS-PRTNRV/tempo
  - Lista em tempo real (onValue)
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getDatabase, ref, push, set, onValue, remove, update, get, child
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBehqlRiCiDniyPi3bjHtkH7q2-Px-KoZc",
  authDomain: "cadastr-produtos-clevir.firebaseapp.com",
  databaseURL: "https://cadastr-produtos-clevir-default-rtdb.firebaseio.com",
  projectId: "cadastr-produtos-clevir",
  storageBucket: "cadastr-produtos-clevir.firebasestorage.app",
  messagingSenderId: "1028296092810",
  appId: "1:1028296092810:web:86859328b19c1fdf511173",
  measurementId: "G-JGE4Q09NX8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const DB_NODE = "RELATORIOS-PESADAS-PRTNRV";
const IMGBB_KEY = "95bb16ee776d7e20f26857cec98bd372"; // já fornecida

// Elements
const filesInput = document.getElementById("files");
const enviarBtn = document.getElementById("enviarBtn");
const listaEl = document.getElementById("lista");
const tempoInput = document.getElementById("tempo");
const salvarTempoBtn = document.getElementById("salvarTempoBtn");
const progressEl = document.getElementById("progress");
const recarregarBtn = document.getElementById("recarregarLista");

let currentTempo = 5000;

// Função util - read file as base64 (no cabeçalho data:...)
function fileToBase64(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = () => {
      // reader.result is like "data:image/png;base64,AAA..."
      const result = reader.result;
      const base64 = result.split(",")[1]; // remove prefix
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Upload single file to ImgBB (returns URL)
async function uploadToImgbbBase64(base64, name){
  const form = new FormData();
  form.append("key", IMGBB_KEY);
  form.append("image", base64);
  // optional fields:
  if(name) form.append("name", name.replace(/\.[^/.]+$/, ""));
  const res = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: form });
  const json = await res.json();
  if(!json || !json.success) throw new Error(json?.error?.message || "Erro ImgBB");
  return json.data.url;
}

// Enviar múltiplas imagens
enviarBtn.addEventListener("click", async () => {
  const files = Array.from(filesInput.files || []);
  if(files.length === 0) return alert("Selecione pelo menos uma imagem.");

  enviarBtn.disabled = true;
  progressEl.textContent = `0 / ${files.length}`;
  let done = 0;

  for(const f of files){
    try{
      const base64 = await fileToBase64(f);
      const url = await uploadToImgbbBase64(base64, f.name);
      const itemRef = push(ref(db, `${DB_NODE}/imagens`));
      const payload = {
        url,
        filename: f.name,
        createdAt: Date.now()
      };
      await set(itemRef, payload);
      done++;
      progressEl.textContent = `${done} / ${files.length}`;
    } catch(err) {
      console.error("Erro upload:", err);
      alert("Erro ao enviar " + f.name + ": " + (err.message || err));
    }
  }

  filesInput.value = "";
  enviarBtn.disabled = false;
  progressEl.textContent = "Concluído";
});

// Salvar tempo
salvarTempoBtn.addEventListener("click", async () => {
  const t = parseInt(tempoInput.value);
  if(isNaN(t) || t <= 0) return alert("Informe um tempo válido em milissegundos (ex: 5000).");
  await update(ref(db, DB_NODE), { tempo: t });
  alert("Tempo salvo: " + t + " ms");
});

// Recarregar / Forçar leitura
recarregarBtn.addEventListener("click", carregarLista);

// Carrega lista em tempo real
function carregarLista(){
  const imagensRef = ref(db, `${DB_NODE}/imagens`);
  onValue(imagensRef, (snap) => {
    listaEl.innerHTML = "";
    const val = snap.val();
    if(!val){
      listaEl.innerHTML = `<div>Nenhuma imagem cadastrada.</div>`;
      return;
    }
    // val: { key: {url,filename,createdAt}, ... }
    const entries = Object.entries(val).sort((a,b)=> (b[1].createdAt||0)-(a[1].createdAt||0));
    for(const [key, data] of entries){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div style="height:90px;overflow:hidden;border-radius:6px"><img src="${data.url}" class="thumb" /></div>
        <div style="margin-top:8px">
          <strong>${data.filename || ""}</strong><br/>
          <small>${new Date((data.createdAt)||0).toLocaleString()}</small>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="small" onclick="mostrar('${key}')">Abrir</button>
          <button class="warn small" onclick="excluir('${key}')">Excluir</button>
        </div>
      `;
      listaEl.appendChild(div);
    }
  });

  // também ler tempo atual
  const rootRef = ref(db, DB_NODE + "/tempo");
  onValue(rootRef, snap => {
    const v = snap.val();
    if(v) { currentTempo = parseInt(v); tempoInput.value = currentTempo; }
  });
}
carregarLista();

// Excluir - exposto globalmente para uso inline
window.excluir = async function(key){
  if(!confirm("Excluir essa imagem?")) return;
  await remove(ref(db, `${DB_NODE}/imagens/${key}`));
  alert("Imagem excluída.");
};

// Abrir imagem em nova aba
window.mostrar = function(key){
  get(ref(db, `${DB_NODE}/imagens/${key}`)).then(s=>{
    const v = s.val();
    if(v?.url) window.open(v.url, "_blank");
  });
};

</script>
</body>
</html>
